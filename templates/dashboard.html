{% extends "base.html" %}

{% block content %}
<!-- IMPORT DE CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- TRANSMISSION SÉCURISÉE DES DONNÉES AU JS -->
<script id="radar-data" type="application/json">
    {{ data.scores_radar | tojson | safe }}
</script>

<div class="dashboard-container" style="max-width: 1000px; margin: 0 auto;">

    <!-- EN-TÊTE : SCORE ET ACTIONS -->
    <div class="dashboard-header"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
        <div>
            <h2 style="color: var(--text-dark); margin-bottom: 5px;">Résultats de l'Audit</h2>
            <p style="color: var(--text-light); font-size: 0.9rem;">
                <i class="fa-solid fa-layer-group"></i> Dimension 6 : Évolutive (Adaptabilité, Innovation, Durabilité)
            </p>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">Score Global de Maturité</div>
            <div class="score-badge"
                style="font-size: 2.5rem; font-weight: 800; color: {{ '#10B981' if data.global >= 60 else '#EF4444' }};">
                {{ data.global }}%
            </div>
        </div>
    </div>

    <!-- ACTIONS (PDF & N8N) -->
    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-bottom: 2rem;">
        <!-- Bouton N8N -->
        <a href="https://amineboubou12.app.n8n.cloud/" target="_blank" class="btn"
            style="background-color: #EA580C; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-weight: 600;">
            <i class="fa-solid fa-bolt"></i> Accéder au Workflow n8n
        </a>

        <!-- Bouton PDF -->
        <a href="{{ url_for('export_pdf') }}" class="btn"
            style="background-color: #EF4444; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-weight: 600;">
            <i class="fa-solid fa-file-pdf"></i> Télécharger le Rapport Complet
        </a>
    </div>

    <!-- DIAGNOSTIC EXPERT -->
    <div class="alert-box"
        style="background: {{ '#ECFDF5' if data.diag.color == 'success' else '#FEF2F2' }}; border-left: 5px solid {{ '#10B981' if data.diag.color == 'success' else '#EF4444' }}; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
        <h4
            style="color: {{ '#065F46' if data.diag.color == 'success' else '#991B1B' }}; margin-top: 0; display: flex; align-items: center; gap: 10px;">
            <i class="fa-solid fa-stethoscope"></i> {{ data.diag.type }}
        </h4>
        <p style="margin-bottom: 0; color: var(--text-dark);">{{ data.diag.message }}</p>
    </div>

    <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">

        <!-- 1. GRAPHIQUE RADAR (DIMENSIONS) -->
        <div class="card fade-up" style="animation-delay: 0.1s;">
            <h3 style="text-align: center; margin-bottom: 1rem; color: var(--primary-dark);">Radar des 3 Piliers</h3>
            <div style="position: relative; height: 300px;">
                <canvas id="radarChart"></canvas>
            </div>
            <div style="text-align: center; margin-top: 15px; font-size: 0.9rem;">
                <span style="margin-right: 10px;"><i class="fa-solid fa-circle"
                        style="color: #10B981; font-size: 8px;"></i> Cible > 3/5</span>
            </div>
        </div>

        <!-- 2. MATRICE DE FARMER (RISQUES) -->
        <div class="card fade-up" style="animation-delay: 0.2s;">
            <h3 style="text-align: center; margin-bottom: 1rem; color: var(--primary-dark);">Cartographie des Risques
            </h3>

            {% if data.risques %}
            <div class="risk-matrix-wrapper"
                style="position: relative; width: 100%; aspect-ratio: 1/1; max-width: 350px; margin: 0 auto;">
                <!-- Axes -->
                <div class="axis-label-y">IMPACT</div>
                <div class="axis-label-x">PROBABILITÉ</div>

                <!-- Grille 3x3 CSS -->
                <div class="farmer-grid">
                    <!-- Ligne 3 (Haut - Impact Fort) -->
                    <div class="zone-yellow"></div>
                    <div class="zone-orange"></div>
                    <div class="zone-red"></div>
                    <!-- Ligne 2 (Milieu - Impact Moyen) -->
                    <div class="zone-green"></div>
                    <div class="zone-yellow"></div>
                    <div class="zone-orange"></div>
                    <!-- Ligne 1 (Bas - Impact Faible) -->
                    <div class="zone-green"></div>
                    <div class="zone-green"></div>
                    <div class="zone-yellow"></div>
                </div>

                <!-- Points de Risques -->
                {% for risque in data.risques %}
                <div class="risk-point" style="
                        left: calc({{ (risque.prob - 1) * 33.33 + 16.6 }}%);
                        top: calc({{ (3 - risque.impact) * 33.33 + 16.6 }}%);
                     " title="{{ risque.nom }} (Imp: {{risque.impact}}, Prob: {{risque.prob}})">
                </div>
                {% endfor %}
            </div>
            <div style="text-align: center; margin-top: 30px; font-size: 0.85rem; color: var(--text-light);">
                Survolez les points pour voir les détails.
            </div>
            {% else %}
            <div
                style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--primary);">
                <i class="fa-solid fa-shield-halved" style="font-size: 3rem; margin-bottom: 10px;"></i>
                <p>Aucun risque critique identifié.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- PLAN D'ACTION / RECOMMANDATIONS -->
    <div class="card fade-up" style="animation-delay: 0.3s;">
        <h3 style="margin-bottom: 1.5rem;"><i class="fa-solid fa-clipboard-list"></i> Plan d'Action Prioritaire</h3>

        {% if data.diag.recos %}
        <div style="display: grid; gap: 15px;">
            {% for reco in data.diag.recos %}
            <div class="reco-item">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <div>
                    <strong>{{ reco.titre }}</strong>
                    <p>{{ reco.texte }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: var(--primary);">
            <i class="fa-solid fa-check-circle"></i> Félicitations, votre SI est conforme aux standards de la Dimension
            6.
        </p>
        {% endif %}
    </div>

</div>

<!-- SCRIPT JS POUR LE GRAPHIQUE -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Récupération des données
        let scores = [0, 0, 0];
        try {
            const dataEl = document.getElementById('radar-data');
            if (dataEl) scores = JSON.parse(dataEl.textContent);
        } catch (e) { console.error("Erreur parsing JSON", e); }

        // Configuration Chart.js
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Adaptabilité', 'Innovation', 'Durabilité (Green IT)'],
                datasets: [{
                    label: 'Niveau de Maturité',
                    data: scores,
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    borderColor: '#10B981',
                    pointBackgroundColor: '#10B981',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#10B981',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 5,
                        min: 0,
                        ticks: { stepSize: 1, display: false },
                        pointLabels: { font: { size: 12, weight: 'bold' }, color: '#374151' }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    });
</script>

<!-- CSS SPÉCIFIQUE POUR CETTE PAGE (Si nécessaire) -->
<style>
    .risk-point:hover {
        transform: translate(-50%, -50%) scale(1.3) !important;
        z-index: 10;
    }
</style>
{% endblock %}